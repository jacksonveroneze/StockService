name: Pipeline

on:
    pull_request:
        types: [opened, reopened, synchronize]
    push:

env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    AUTHORIZATION_CLIENT_ID: ${{ secrets.AUTHORIZATION_CLIENT_ID }}
    AUTHORIZATION_CLIENT_SECRET: ${{ secrets.AUTHORIZATION_CLIENT_SECRET }}

jobs:
    commitlint:
        name: Commit Lint
        runs-on: ubuntu-20.04

        steps:
            - uses: actions/checkout@v2
              with:
                  fetch-depth: 0
            - uses: wagoid/commitlint-github-action@v2

    install-dotnet:
        name: Install .NET
        runs-on: ubuntu-20.04
        needs: commitlint

        steps:
            - uses: actions/checkout@v2
            - name: Setup .NET
              uses: actions/setup-dotnet@v1
              with:
                  dotnet-version: '5.0.x'

            - name: Cache .NET
              uses: actions/cache@v1
              with:
                  path: /usr/share/dotnet
                  key: ${{ runner.os }}-dotnet
                  restore-keys: ${{ runner.os }}-dotnet

    build:
        name: Build
        runs-on: ubuntu-20.04
        needs: install-dotnet

        steps:
            - uses: actions/checkout@v2

            - name: Restore dependencies
              run: /usr/share/dotnet/dotnet restore

            - name: dotnet publish
              run: /usr/share/dotnet/dotnet publish -c Release

    test:
        name: Test
        runs-on: ubuntu-20.04
        needs: build

        steps:
            - uses: actions/checkout@v2

            - name: Restore dependencies
              run: /usr/share/dotnet/dotnet restore

            - name: Test
              run: /usr/share/dotnet/dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
