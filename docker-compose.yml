version: "3.8"
services:
    api:
        container_name: api
        image: docker.pkg.github.com/jacksonveroneze/stock-service/stock-service:0.0.1
        tty: true
        build:
            context: .
            dockerfile: Dockerfile
        environment:
            - ASPNETCORE_URLS=http://+:80
            - DOTNET_RUNNING_IN_CONTAINER=true
            - ASPNETCORE_ENVIRONMENT=Production
            - APP_CONFIG_Urls_Allow_Cors=*;
            - APP_CONFIG_ApplicationInsights_InstrumentationKey=
            - APP_CONFIG_ConnectionStrings__DefaultConnection=Server=database;Database=stock;User Id=SA;Password=localPass@word;
            - APP_CONFIG_Auth__Authority=https://jacksonveroneze.auth0.com/
            - APP_CONFIG_Auth__Audience=https://stock-jacksonveroneze.azurewebsites.net
            - APP_CONFIG_Serilog__MinimumLevel__Default=Debug
            - APP_CONFIG_Serilog__MinimumLevel__Override__Microsoft=Information
            - APP_CONFIG_Serilog__MinimumLevel__Override__System=Information
            - APP_CONFIG_BusType=RabbitMq
            - APP_CONFIG_BusRabbitMq__Host=localhost
            - APP_CONFIG_BusRabbitMq__VirtualHost=stock_service
            - APP_CONFIG_BusRabbitMq__Username=guest
            - APP_CONFIG_BusRabbitMq__Password=guest
        healthcheck:
            test: curl --silent --fail http://api/health || exit 1
            interval: 15s
            timeout: 3s
            start_period: 5s
            retries: 3
        links:
            - database
            - rabbitmq
        depends_on:
            -   database
        ports:
            - 8080:80

    database:
        container_name: database
        image: mcr.microsoft.com/mssql/server:2019-latest
        environment:
            SA_PASSWORD: localPass@word
            ACCEPT_EULA: Y
        healthcheck:
            test: [ "CMD", "/opt/mssql-tools/bin/sqlcmd", "-Usa", "-PlocalPass@word", "-Q", "select 1" ]
            interval: 15s
            timeout: 3s
            start_period: 5s
            retries: 3
        ports:
            - 1433:1433

    rabbitmq:
        image: rabbitmq:3.8-management-alpine
        container_name: rabbitmq
        environment:
            - RABBITMQ_DEFAULT_USER=guest
            - RABBITMQ_DEFAULT_PASS=guest
        healthcheck:
            test: curl --silent --fail http://rabbitmq:15672 || exit 1
            interval: 15s
            timeout: 3s
            start_period: 5s
            retries: 3
        volumes:
            - rabbitmq:/var/lib/rabbitmq
        ports:
            - 15672:15672
            - 5672:5672

volumes:
    database:
    rabbitmq:
